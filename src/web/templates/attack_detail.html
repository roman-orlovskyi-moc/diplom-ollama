{% extends "base.html" %}

{% block title %}{{ attack.name }} - Attack Details{% endblock %}

{% block content %}
{% set severity_colors = {'critical': 'danger', 'high': 'warning', 'medium': 'info', 'low': 'secondary'} %}

<div class="row">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/attacks">Attacks</a></li>
                <li class="breadcrumb-item active">{{ attack.id }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <h1>
            <i class="bi bi-bug"></i> {{ attack.name }}
        </h1>
        <p class="lead">{{ attack.description }}</p>
    </div>
    <div class="col-md-4 text-end">
        <span class="badge bg-{{ severity_colors[attack.severity] }} fs-5">
            {{ attack.severity|upper }}
        </span>
    </div>
</div>

<hr>

<!-- Attack Metadata -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-info-circle"></i> Attack Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Attack ID:</strong> <code>{{ attack.id }}</code></p>
                        <p><strong>Category:</strong> <span class="badge bg-primary">{{ attack.category|replace('_', ' ')|title }}</span></p>
                        <p><strong>Severity:</strong> <span class="badge bg-{{ severity_colors[attack.severity] }}">{{ attack.severity|upper }}</span></p>
                    </div>
                    <div class="col-md-6">
                        {% if attack.attack_indicators %}
                        <p><strong>Attack Indicators:</strong></p>
                        <ul>
                            {% for indicator in attack.attack_indicators %}
                            <li><code>{{ indicator }}</code></li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attack Context -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-code-square"></i> Attack Context</h5>
            </div>
            <div class="card-body">
                <!-- System Prompt -->
                <div class="mb-3">
                    <label class="form-label"><strong>System Prompt:</strong></label>
                    <pre class="bg-light p-3 rounded"><code>{{ attack.context.system_prompt }}</code></pre>
                </div>

                <!-- Conversation History (for multi-turn attacks) -->
                {% if attack.context.conversation_history %}
                <div class="mb-3">
                    <label class="form-label"><strong>Conversation History:</strong></label>
                    <div class="bg-light p-3 rounded">
                        {% for turn in attack.context.conversation_history %}
                        <div class="mb-2 pb-2 {% if not loop.last %}border-bottom{% endif %}">
                            <small class="text-muted"><strong>{{ turn.role|title }}:</strong></small>
                            <pre class="mb-0 mt-1"><code>{{ turn.content }}</code></pre>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- User Message -->
                <div class="mb-3">
                    <label class="form-label"><strong>User Message (Attack):</strong></label>
                    <pre class="bg-danger bg-opacity-10 p-3 rounded border border-danger"><code>{{ attack.context.user_message }}</code></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Expected Behavior -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-shield-check"></i> Expected Behavior</h5>
            </div>
            <div class="card-body">
                <p>{{ attack.expected_behavior }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Success Criteria -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-clipboard-check"></i> Success Criteria</h5>
            </div>
            <div class="card-body">
                <p><strong>Type:</strong> <code>{{ attack.success_criteria.type }}</code></p>

                {% if attack.success_criteria.patterns %}
                <p><strong>Detection Patterns:</strong></p>
                <ul>
                    {% for pattern in attack.success_criteria.patterns %}
                    <li><code>{{ pattern }}</code></li>
                    {% endfor %}
                </ul>
                {% endif %}

                {% if attack.success_criteria.forbidden_topics %}
                <p><strong>Forbidden Topics:</strong></p>
                <ul>
                    {% for topic in attack.success_criteria.forbidden_topics %}
                    <li>{{ topic }}</li>
                    {% endfor %}
                </ul>
                {% endif %}

                {% if attack.success_criteria.sensitive_patterns %}
                <p><strong>Sensitive Patterns:</strong></p>
                <ul>
                    {% for pattern in attack.success_criteria.sensitive_patterns %}
                    <li><code>{{ pattern }}</code></li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="d-grid gap-2 d-md-flex justify-content-md-between">
            <a href="/attacks" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Attacks
            </a>
            <div>
                <a href="/demo?attack={{ attack.id }}" class="btn btn-primary">
                    <i class="bi bi-play-circle"></i> Test This Attack
                </a>
                <a href="/comparison?attack={{ attack.id }}" class="btn btn-success">
                    <i class="bi bi-bar-chart"></i> Compare Defenses
                </a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
    pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 0.9rem;
    }

    code {
        color: #d63384;
    }
</style>
{% endblock %}